<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Potree简单测试</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f0f0f0;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }

    button:hover {
      background: #1976D2;
    }

    #log {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
      font-size: 12px;
      margin: 10px 0;
    }

    #renderContainer {
      width: 100%;
      height: 400px;
      border: 1px solid #ddd;
      margin: 10px 0;
      position: relative;
    }

    .status {
      padding: 5px 10px;
      border-radius: 3px;
      margin: 5px 0;
      font-weight: bold;
    }

    .status.ok {
      background: #4CAF50;
      color: white;
    }

    .status.error {
      background: #f44336;
      color: white;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Potree简单测试</h1>

    <div>
      <button onclick="testBasic()">基础测试</button>
      <button onclick="testFileLoad()">文件加载测试</button>
      <button onclick="testPotreeLoad()">Potree加载测试</button>
      <button onclick="clearLog()">清空日志</button>
    </div>

    <div id="renderContainer"></div>
    <div id="log"></div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

    let scene, camera, renderer, controls;
    let Potree = null;

    function log (message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const typeIcon = {
        'success': '✓',
        'error': '✗',
        'warning': '⚠',
        'info': 'ℹ'
      }[type] || 'ℹ';

      const logEntry = `[${timestamp}] ${typeIcon} ${message}\n`;
      logDiv.textContent += logEntry;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function initScene () {
      const container = document.getElementById('renderContainer');

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x000000);

      camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
      camera.position.set(0, 0, 10);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(container.clientWidth, container.clientHeight);
      container.appendChild(renderer.domElement);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(10, 10, 5);
      scene.add(directionalLight);

      const axesHelper = new THREE.AxesHelper(5);
      scene.add(axesHelper);

      animate();
      log('✓ Three.js场景初始化完成', 'success');
    }

    function animate () {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    async function importPotree () {
      try {
        const potreeModule = await import('potree-core');
        Potree = potreeModule.Potree || potreeModule.default;
        log('✓ Potree导入成功', 'success');
        return true;
      } catch (error) {
        log(`✗ Potree导入失败: ${error.message}`, 'error');
        return false;
      }
    }

    window.testBasic = async function () {
      log('=== 基础测试 ===', 'info');

      if (!scene) {
        initScene();
      }

      // 检查WebGL
      const canvas = document.createElement('canvas');
      const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
      if (gl) {
        log('✓ WebGL支持正常', 'success');
      } else {
        log('✗ WebGL不支持', 'error');
      }

      // 检查Three.js
      if (typeof THREE !== 'undefined') {
        log('✓ Three.js加载正常', 'success');
        log(`  Three.js版本: ${THREE.REVISION}`, 'info');
      } else {
        log('✗ Three.js未加载', 'error');
      }

      // 检查OrbitControls
      if (typeof OrbitControls !== 'undefined') {
        log('✓ OrbitControls加载正常', 'success');
      } else {
        log('✗ OrbitControls未加载', 'error');
      }

      // 检查Potree
      const potreeImported = await importPotree();
      if (potreeImported) {
        try {
          const potree = new Potree();
          log('✓ Potree实例创建成功', 'success');

          if (typeof potree.loadPointCloud === 'function') {
            log('✓ loadPointCloud方法存在', 'success');
          } else {
            log('✗ loadPointCloud方法不存在', 'error');
          }
        } catch (error) {
          log(`✗ Potree实例创建失败: ${error.message}`, 'error');
        }
      }
    };

    window.testFileLoad = async function () {
      log('=== 文件加载测试 ===', 'info');

      const testPaths = [
        '/public/data/lion_takanawa/cloud.js',
        '/data/lion_takanawa/cloud.js'
      ];

      for (const path of testPaths) {
        try {
          const response = await fetch(path);
          if (response.ok) {
            log(`✓ 文件可访问: ${path}`, 'success');

            const text = await response.text();
            log(`  文件大小: ${text.length} 字符`, 'info');

            // 尝试解析JSON
            try {
              const data = JSON.parse(text.trim());
              log(`  版本: ${data.version}`, 'info');
              log(`  边界框: ${JSON.stringify(data.boundingBox)}`, 'info');
            } catch (parseError) {
              log(`✗ JSON解析失败: ${parseError.message}`, 'error');
            }
          } else {
            log(`✗ 文件不可访问: ${path} (${response.status})`, 'error');
          }
        } catch (error) {
          log(`✗ 文件访问失败: ${path} - ${error.message}`, 'error');
        }
      }
    };

    window.testPotreeLoad = async function () {
      log('=== Potree加载测试 ===', 'info');

      if (!Potree) {
        const imported = await importPotree();
        if (!imported) {
          log('✗ Potree导入失败，无法进行加载测试', 'error');
          return;
        }
      }

      if (!scene) {
        initScene();
      }

      // 清除现有对象
      scene.children = scene.children.filter(child =>
        child.type === 'AmbientLight' ||
        child.type === 'DirectionalLight' ||
        child.type === 'AxesHelper'
      );

      try {
        const potree = new Potree();
        log('✓ Potree实例创建成功', 'success');

        log('尝试加载点云...', 'info');

        // 尝试多个路径
        const paths = [
          '/public/data/lion_takanawa/',
          '/data/lion_takanawa/'
        ];

        for (const basePath of paths) {
          try {
            log(`尝试路径: ${basePath}`, 'info');
            const pco = await potree.loadPointCloud('cloud.js', basePath);

            log('✓ Potree点云加载成功', 'success');
            log(`  点云对象:`, pco);

            if (pco.material) {
              pco.material.size = 2.0;
              pco.material.shape = 2;
            }
            pco.visible = true;

            scene.add(pco);
            log('✓ 点云已添加到场景', 'success');

            // 调整相机
            if (pco.pcoGeometry && pco.pcoGeometry.boundingBox) {
              const box = pco.pcoGeometry.boundingBox;
              const center = box.getCenter(new THREE.Vector3());
              const size = box.getSize(new THREE.Vector3());
              const maxDim = Math.max(size.x, size.y, size.z);

              camera.position.set(center.x, center.y, center.z + maxDim * 2);
              camera.lookAt(center);
              controls.target.copy(center);
              controls.update();

              log(`  相机调整到点云中心: ${center.x}, ${center.y}, ${center.z}`, 'info');
            }

            return; // 成功加载，退出循环

          } catch (error) {
            log(`✗ 路径 ${basePath} 失败: ${error.message}`, 'error');
          }
        }

        log('✗ 所有路径都失败', 'error');

      } catch (error) {
        log(`✗ Potree加载失败: ${error.message}`, 'error');
        log(`  错误堆栈: ${error.stack}`, 'error');
      }
    };

    window.clearLog = function () {
      document.getElementById('log').textContent = '';
    };

    // 页面加载时初始化
    window.addEventListener('load', () => {
      log('Potree简单测试页面加载完成', 'info');
      initScene();
    });
  </script>
</body>

</html>